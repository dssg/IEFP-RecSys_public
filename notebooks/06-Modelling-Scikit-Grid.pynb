{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Notebook Magic"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "%matplotlib inline\n",
    "%load_ext autoreload"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Imports"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "import yaml\n",
    "import pandas as pd\n",
    "import matplotlib.pyplot as plt\n",
    "import pandas as pd\n",
    "import seaborn as sns\n",
    "import numpy as np\n",
    "\n",
    "from sklearn.model_selection import cross_validate\n",
    "from sklearn.ensemble import RandomForestClassifier\n",
    "from sklearn.model_selection import train_test_split\n",
    "from sklearn.metrics import accuracy_score\n",
    "from sklearn.metrics import average_precision_score\n",
    "from sklearn.metrics import precision_recall_curve\n",
    "from sklearn.metrics import confusion_matrix\n",
    "from sklearn.metrics import auc, roc_curve\n",
    "\n",
    "from sklearn.linear_model import LogisticRegression, Lasso\n",
    "\n",
    "from sklearn.metrics import f1_score\n",
    "from sklearn.model_selection import GridSearchCV\n",
    "from sklearn.pipeline import Pipeline\n",
    "\n",
    "from scipy.stats import randint"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [],
   "source": [
    "df = pd.read_parquet(\"s3://iefp-unemployment/intermediate/transform/intermediate.parquet\")\n",
    "df.shape\n",
    "\n",
    "df = df[df.d_age.notna()]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "['user_id',\n",
       " 'journey_count',\n",
       " 'register_date',\n",
       " 'register_reason',\n",
       " 'exit_date_21',\n",
       " 'exit_date_31',\n",
       " 'exit_reason',\n",
       " 'd_birth_date',\n",
       " 'd_gender',\n",
       " 'd_age',\n",
       " 'd_disabled',\n",
       " 'd_dependents',\n",
       " 'd_professional_training',\n",
       " 'd_profession_card',\n",
       " 'd_school_qualification',\n",
       " 'd_college_qualification',\n",
       " 'd_civil_status',\n",
       " 'd_registration_type',\n",
       " 'd_nationality',\n",
       " 'd_parish',\n",
       " 'd_center',\n",
       " 'd_subsidy',\n",
       " 'd_rsi',\n",
       " 'd_previous_cpp',\n",
       " 'd_previous_job_experience',\n",
       " 'd_desired_cpp',\n",
       " 'd_desired_location',\n",
       " 'd_desired_work_time',\n",
       " 'd_desired_contract',\n",
       " 'success',\n",
       " 'ttj_sub_9',\n",
       " 'intervention_date_207',\n",
       " 'intervention_date_208',\n",
       " 'intervention_date_218',\n",
       " 'intervention_date_219',\n",
       " 'intervention_date_225',\n",
       " 'intervention_date_226',\n",
       " 'intervention_date_235',\n",
       " 'intervention_date_319',\n",
       " 'intervention_date_321',\n",
       " 'intervention_date_323',\n",
       " 'intervention_date_327',\n",
       " 'intervention_date_328',\n",
       " 'intervention_date_329',\n",
       " 'intervention_date_394',\n",
       " 'intervention_date_404',\n",
       " 'intervention_date_416',\n",
       " 'intervention_date_427',\n",
       " 'intervention_date_428',\n",
       " 'intervention_date_429',\n",
       " 'intervention_date_430',\n",
       " 'intervention_date_506',\n",
       " 'intervention_date_507',\n",
       " 'intervention_date_603',\n",
       " 'intervention_date_610',\n",
       " 'intervention_date_611',\n",
       " 'intervention_date_612',\n",
       " 'intervention_date_613',\n",
       " 'intervention_date_615',\n",
       " 'intervention_date_700',\n",
       " 'intervention_date_7005',\n",
       " 'intervention_date_7017',\n",
       " 'intervention_date_7019',\n",
       " 'intervention_date_728',\n",
       " 'intervention_date_729',\n",
       " 'intervention_date_733',\n",
       " 'intervention_date_735',\n",
       " 'intervention_date_739',\n",
       " 'intervention_date_742',\n",
       " 'intervention_date_745',\n",
       " 'intervention_date_747',\n",
       " 'intervention_date_749',\n",
       " 'intervention_date_767',\n",
       " 'intervention_date_768',\n",
       " 'intervention_date_769',\n",
       " 'intervention_date_770',\n",
       " 'intervention_date_771',\n",
       " 'intervention_date_772',\n",
       " 'intervention_date_777',\n",
       " 'intervention_date_778',\n",
       " 'intervention_date_784',\n",
       " 'intervention_date_785',\n",
       " 'intervention_date_791',\n",
       " 'intervention_date_794',\n",
       " 'intervention_date_795',\n",
       " 'intervention_date_796',\n",
       " 'intervention_date_797',\n",
       " 'intervention_date_9902',\n",
       " 'intervention_date_9903',\n",
       " 'intervention_date_9904',\n",
       " 'intervention_date_9906',\n",
       " 'intervention_date_9907']"
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df.columns.tolist()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Intervention feature preparation\n",
    "\n",
    "interv_cols = [col for col in df.columns if \"intervention\" in col]\n",
    "X = df[interv_cols].copy()\n",
    "\n",
    "# Strip col names\n",
    "X.columns = [col.replace(\"intervention_date_\", \"\") for col in X.columns]\n",
    "\n",
    "# Make df boolean\n",
    "X = (X.notna()).astype('int')\n",
    "\n",
    "# Filter for frequent interventions\n",
    "frequent_i = X.mean()[X.mean() > 0.01].index.tolist()\n",
    "X = X[frequent_i]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 43,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Demographics prep\n",
    "\n",
    "dems = [\"d_age\", \"d_gender\", \"d_civil_status\", \"d_rsi\", \"d_desired_work_time\", \"d_desired_contract\",\n",
    "       \"d_school_qualification\", \"d_college_qualification\", \"d_disabled\", \"d_subsidy\", \"d_previous_cpp\",\n",
    "       \"d_desired_cpp\", \"d_previous_job_experience\"]\n",
    "\n",
    "#Filling NAs!!\n",
    "\n",
    "X[dems] = df[dems].fillna(0)\n",
    "X[\"register_month\"] = df.register_date.dt.month\n",
    "X[\"register_year\"] = df.register_date.dt.year\n",
    "X = pd.get_dummies(X, drop_first=True, dummy_na=True)\n",
    "X.head()\n",
    "\n",
    "# Set output variable\n",
    "\n",
    "Y = df[\"ttj_sub_9\"]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 44,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Test/Train split\n",
    "\n",
    "\n",
    "X_train, X_test, y_train, y_test = train_test_split(X, Y, test_size=0.4, random_state=0)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 45,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Prepare pipeline\n",
    "\n",
    "pipeline = Pipeline([\n",
    "    ('rf', RandomForestClassifier(random_state=0)),\n",
    "])\n",
    "\n",
    "#pipeline.fit(X_train,y_train)\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Grid search\n",
    "\n",
    "param_grid = [\n",
    "        {'rf__n_estimators': [250, 500],\n",
    "         'rf__max_depth': [None, 2, 3]\n",
    "        },\n",
    "    ]\n",
    "\n",
    "'''\n",
    "'rf__max_features': [2, 3],\n",
    "'rf__min_samples_leaf': [5, 10],\n",
    "'rf__max_depth': [None, 2, 3]\n",
    "'''\n",
    "\n",
    "# create the GridSearchCV object\n",
    "grid_search = GridSearchCV(pipeline, param_grid, cv=3, refit=True)\n",
    "\n",
    "# fine-tune the hyperparameters\n",
    "grid_search.fit(X_train, y_train)\n",
    "\n",
    "# get the best model\n",
    "final_model = grid_search.best_estimator_\n",
    "\n",
    "# predict using the test dataset\n",
    "print(confusion_matrix(y_test, final_model.predict(X_test)))\n",
    "\n",
    "print(accuracy_score(y_test, final_model.predict(X_test)))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "0.4378041658555577 Precision at 0.8 Recall\n"
     ]
    },
    {
     "data": {
      "image/png": "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\n",
      "text/plain": [
       "<Figure size 432x288 with 1 Axes>"
      ]
     },
     "metadata": {
      "needs_background": "light"
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "# Precision / Recall graph\n",
    "\n",
    "\n",
    "def plot_precision_recall(y_test, y_pred, y_prob):\n",
    "    average_precision = average_precision_score(y_test, y_pred)\n",
    "    precision, recall, _ = precision_recall_curve(y_test, y_prob)\n",
    "    print(\"{} Precision at {} Recall\".format(precision[recall>0.8].max(), 0.8))\n",
    "\n",
    "    step_kwargs = ({'step': 'post'})\n",
    "    plt.step(recall, precision, color='b', alpha=0.2, where='post')\n",
    "    plt.fill_between(recall, precision, alpha=0.2, color='b', **step_kwargs)\n",
    "\n",
    "    plt.xlabel('Recall')\n",
    "    plt.ylabel('Precision')\n",
    "    plt.ylim([0.0, 1.05])\n",
    "    plt.xlim([0.0, 1.0])\n",
    "    plt.title('2-class Precision-Recall curve: AP={0:0.2f}'.format(average_precision))\n",
    "\n",
    "y_pred = pipeline.predict(X_test)\n",
    "y_prob = pipeline.predict_proba(X_test)[:,1]\n",
    "plot_precision_recall(y_test, y_pred, y_prob)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Roc curve\n",
    "\n",
    "fpr, tpr, threshold = roc_curve(y_test, y_prob)\n",
    "roc_auc = auc(fpr, tpr)\n",
    "plt.title('Receiver Operating Characteristic')\n",
    "plt.plot(fpr, tpr, 'b', label = 'AUC = %0.2f' % roc_auc)\n",
    "plt.legend(loc = 'lower right')\n",
    "plt.plot([0, 1], [0, 1],'r--')\n",
    "plt.xlim([0, 1])\n",
    "plt.ylim([0, 1])\n",
    "plt.ylabel('True Positive Rate')\n",
    "plt.xlabel('False Positive Rate')\n",
    "plt.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Feature importance\n",
    "\n",
    "pd.Series(rf.feature_importances_, X_train.columns).sort_values(ascending=False).head(20)"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "iefp",
   "language": "python",
   "name": "iefp"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.6.8"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
